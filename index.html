<!DOCTYPE html>
<html lang="en">
<meta charset='UTF-8'>
<head>
  <link rel="stylesheet" href="css/normalize.css" />
  <link rel="stylesheet" href="css/skeleton.css" />
  <link rel="stylesheet" href="css/digital_style.css" />
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,300,600" />
  <script src='http://code.jquery.com/jquery-1.12.0.min.js'></script>
  <script src='index.js'></script>
</head>

<body onload="loadState($('form'))">
  <div class="section intro-header" style="background-image: url('img/header.png')">
    <div class="container">
      <h1 class="section-heading">
        Let's build a hat rack <span class="repo-name"></span>
      </h1>
    </div>
  </div>

  <div class="section">
    <div class="container">
      <div class="row">
        <div class="twelve columns">
          <div id='initial-form'>
            <form name='auth-and-repo' onsubmit='bootstrapRun();return false;'>
              <label for='repo'>
                Repository: <input name='repo' value='LABHR/octohatrack' type='text' />
              </label>
              <label for='basic-auth'>
                <input type='radio' name='auth' value='basic' id='basic-auth'/> Basic Authentication
                <div class='auth-subform'>
                  <label for='username'>Username: <input name='username' id='username' type='text' /></label>
                  <label for='pass-token'>
                    Password or <a href='https://github.com/settings/tokens'>Token</a>:
                    <input name='pass-token' type='password' id='pass-token' />
                  </label>
                </div>
              </label>
              <label for='oauth'>
                <input type='radio' name='auth' value='oauth' id='oauth'/> OAuth Token Authentication
                <div class='auth-subform'>
                  <label for='oauth-token'>OAuth Token: <input name='oauth-token' id='oauth-token' type='text' /></label>
                </div>
              </label>
              <input type='submit' value='Build a Hat Rack' />
            </form>
          </div>
          <div id='all-contributors' style='display:none'>
            <h1>Contributors</h1>
              <span class='progress'></span>
              <div id='contributors' class='contributors'>
            </div>
          </div>
          <footer>
            Generated by a <a href='https://github.com/leesdolphin/js-hatrack'>JavaScript</a> port
            of <a href='https://github.com/LABHR/octohatrack'>octohatrack</a>. Part of the <a href="https://labhr.github.io/">Let's All Build a Hat Rack project</a>.
          </footer>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* eslint-env jquery */
    function runForProject (project, cachedRequest) {
      function contributorToHtml (project, contributor, type) {
        var username = contributor['login']
        var userDisplayName = contributor['name'] || username
        var url = 'https://github.com/' + project + '/issues?q=involves:' + username
        var avatar = contributor['avatar_url'] + '&s=128'

        // Construct the contibutor's HTML using jQuery.
        var surounding_div = $('<div class="' + type + '">')
        var linkTag = $('<a href="' + url + '"></a>')
        var avatarImg = $('<img src="' + avatar + '" width="128" alt="' + username + '">')
        var overlay = $('<div class="overlay"></div>')
        linkTag.append(avatarImg, overlay)
        var displayName = $('<div>' + userDisplayName + '</div>')

        return surounding_div.append(linkTag, displayName)
      }

      var removeProgressSpinners = createSpinners('.progress')
      var hatRack = window.Labhr('https://api.github.com', cachedRequest)

      var totalContributors = 0;

      hatRack.load(project, function (contributors) {
        if (contributors['codeContributors']) {
          totalContributors += contributors['codeContributors'].length
          contributors['codeContributors'].forEach(function (contributor) {
            addContributor(contributorToHtml(project, contributor, 'code'))
          })
        }
        if (contributors['nonCodeOnlyContributors']) {
          totalContributors += contributors['nonCodeOnlyContributors'].length
          contributors['nonCodeOnlyContributors'].forEach(function (contributor) {
            addContributor(contributorToHtml(project, contributor, 'non-code'))
          })
        }
      }).then(function () {
        // All loading is complete
        removeProgressSpinners()
      })
    }

    // Hacky version of a random shuffle
    function addContributor (codeHtml) {
      var children = $('#contributors').children()
      if (children.length === 0) {
        // No children so just.
        $('#contributors').append(codeHtml)
      } else {
        var random_index = Math.floor(Math.random() * (children.length + 1))
        if (random_index === children.length) {
          // Add at the end.
          $('#contributors').append(codeHtml)
        } else {
          // Otherwise insert it before the chosen element.
          $(children[random_index]).before(codeHtml)
        }
      }
    }

    function bootstrapRun () {
      var authType = $('input:radio[name=auth]:checked').val()
      var headers = {}
      if (authType === 'oauth') {
        headers['Authorization'] = 'Token ' + $('input[name=oauth-token]').val()
      } else if (authType === 'basic') {
        var username = $('input[name=username]').val()
        var passOrToken = $('input[name=pass-token]').val()
        // This may cause problems later for reasons that I don't fully understand.
        // Mostly surounding UTF-8 characters, or something about ':'s in the name.
        headers['Authorization'] = 'Basic ' + window.btoa(username + ':' + passOrToken)
      } else {
        if (!window.confirm('No authentication set up. This can cause problems.\nShould we continue?')) {
          return
        }
      }
      saveState($('form'))
      var cache = {}
      function cachedRequest (url) {
        if (cache[url]) {
          return cache[url]
        } else {
          var response = cache[url] = $.ajax(url, {
            method: 'GET',
            headers: headers
          })
          response.then(function (json, status, response) {
            // Part of me wants to add localStorage caching ... another part of me doesn't care.
          })
          return response
        }
      }
      var repo = $('input[name=repo]').val()
      $('.repo-name').html('for <a href="https://github.com/' + repo + '">' + repo + '</a>')
      $('#initial-form').hide()
      $('#all-contributors').show()
      runForProject(repo, cachedRequest)
    }

    function loadState (form) {
      form = $(form)
      var formName = form.attr('name') || 'pageForm'
      if (window.localStorage[formName]) {
        var formState = window.localStorage[formName]
        try {
          var data = JSON.parse(formState)
        } catch (e) {
          window.localStorage.removeItem(formName)
          return
        }
        data.forEach(function (formItem) {
          var name = formItem.name
          var value = formItem.value
          var inputs = form.find('input[name=' + name + ']')
          if (inputs.length === 1) {
            inputs.val(value)
          } else {
            inputs.each(function () {
              this.checked = (this.value === value)
            })
          }
        })
      }
    }
    function saveState (form) {
      form = $(form)
      var formName = $(form).attr('name') || 'pageForm'
      var data = form.serializeArray()
      window.localStorage.setItem(formName, JSON.stringify(data))
    }
    function createSpinners (selector) {
      // I needed a progress spinner thing, and this was quick and hacky
      var addedElms = $(selector).html(
        '<span>&#8226;</span><span>&#8226;</span><span>&#8226;</span>'
      )
      var progressSpinnerTimeout = 0
      function timer (currIdx) {
        var progress = $('.progress')
        if (progress) {
          progressSpinnerTimeout = setTimeout(timer, 300, (currIdx % 3) + 1)
          $('.progress span').css('font-size', '16px')
          // nth-child is 1 indexed so we use currIdx from 1-3(inclusive)
          $('.progress span:nth-child(' + currIdx + ')').css('font-size', '20px')
        }
      }
      timer(1)
      return function () {
        window.clearTimeout(progressSpinnerTimeout)
        addedElms.remove()
      }
    }
  </script>
</body>
</html>
