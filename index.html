<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset='UTF-8'>
  <script>
    if (window.location.protocol !== 'https:') {
      // Not secure - Redirect to the secure version.
      // Please just comment this out for your own development.
      (function() {
        var newLocation = (window.location + '').substring(window.location.protocol.length)
        window.location.replace('https:' + newLocation)
      })()
    }
  </script>
  <link rel="stylesheet" href="css/normalize.css" />
  <link rel="stylesheet" href="css/skeleton.css" />
  <link rel="stylesheet" href="css/digital_style.css" />
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,300,600" />
  <script src='https://code.jquery.com/jquery-1.12.0.min.js'></script>
  <script src='lib/index.js'></script>
  <script src='lib/other/oauth.js'></script>
  <script>
  OAuth.initialize('KUhN5ym8PYgEIgAy1hli3zBNN-g')
  </script>
  <title>Let's Build a Hat Rack</title>
</head>

<body>
  <div class="section intro-header" style="background-image: url('img/header.png')">
    <div class="container">
      <div class='u-pull-left header-link'>
        <a href="#" id='choose-again'>&lt; choose another repo</a>
      </div>
      <div class='u-pull-right header-link'>
        <a href="#" id='permish-link'>permish-link</a>
      </div>
      <h1 class="section-heading">
        Let's build a hat rack<span class="repo-name"></span>
      </h1>
    </div>
  </div>

  <div class="section">
    <div class="container">
      <div id='initial-form'>
        <form name='auth-and-repo' id='auth-and-repo'>
          <div class="row">
            <div class="twelve columns">
              <label for='repo'>Repository</label>
              <input class="u-full-width" name='repo' value='LABHR/octohatrack' type='text' />
            </div>
          </div>
          <div class="row center-row">
            <div class="twelve columns">
              <button class="button-primary" id='github-oauth'>
                <img src='img/GitHub-Mark-120px-plus.png' class='buttom-img' />
                Login with GitHub
              </button>
            </div>
          </div>
          <div class="row center-row ">
            <div class="or-box">
              <span>
                OR
              </span>
            </div>
          </div>
          <div class="row">
            <div class="six columns">
              <label for='username'>Username</label>
              <input class="u-full-width" name='username' id='username' type='text' />
            </div>
            <div class="six columns">
              <label for='token'>
                <a href='https://github.com/settings/tokens'>Personal Access Token</a>
              </label>
              <input class="u-full-width" name='pass-token' type='password' id='token' />
            </div>
          </div>
          <div class="row center-row">
            <div class="twelve columns">
              <button class="button-primary" id='github-basic'>Login</button>
            </div>
          </div>
        </form>
      </div>
      <div id='all-contributors' style='display:none'>
        <div class='row'>
          <h1>Contributors<span class='progress'></span></h1>
          <div id='contributors' class='contributors'>
          </div>
        </div>
      </div>
      <footer>
        Generated by a <a href='https://github.com/labhr/js-hatrack'>JavaScript</a> port
        of <a href='https://github.com/LABHR/octohatrack'>octohatrack</a>. Part of the
        <a href="https://labhr.github.io/">Let's All Build a Hat Rack project</a>.
        <div class='site-footer-credits'>

        </div>
      </footer>
    </div>

  </div>
  <script>
    /* eslint-env jquery */
    function runForProject (project, cachedRequest) {
      window.location.hash = 'repo=' + window.encodeURI(project)
      $('#permish-link').attr('href', window.location)
      $('.repo-name').html(' for <a href="https://github.com/' + project + '">' + project + '</a>')
      $('.play-again').show()
      $('#initial-form').hide()
      $('#all-contributors').show()
      var removeProgressSpinners = createSpinners($('.progress').empty())
      var hatRack = window.Labhr('https://api.github.com', cachedRequest)

      var totalContributors = 0;

      hatRack.load(project, function (contributors) {
        if (contributors['codeContributors']) {
          totalContributors += contributors['codeContributors'].length
          contributors['codeContributors'].forEach(function (contributor) {
            addContributor(contributorToHtml(project, contributor, 'code'))
          })
        }
        if (contributors['nonCodeOnlyContributors']) {
          totalContributors += contributors['nonCodeOnlyContributors'].length
          contributors['nonCodeOnlyContributors'].forEach(function (contributor) {
            addContributor(contributorToHtml(project, contributor, 'non-code'))
          })
        }
      }).then(function () {
        // All loading is complete
        removeProgressSpinners()
      })
    }

    function bootstrapBasic (repo) {
      var username = $('input[name=username]').val()
      var passOrToken = $('input[name=pass-token]').val()
      // btoa may cause problems later for reasons that I don't fully understand.
      // Mostly surounding UTF-8 characters, or something about ':'s in the name.
      var headers = {'Authorization': 'Basic ' + window.btoa(username + ':' + passOrToken)}
      var cache = {}
      function cachedRequest (url) {
        if (cache[url]) {
          return cache[url]
        } else {
          var response = cache[url] = $.ajax(url, {
            method: 'GET',
            headers: headers
          })
          return response
        }
      }
      runForProject(repo, cachedRequest)
    }

    function bootstrapOauth (repo, oauth) {
      var cache = {}
      function cachedRequest (url) {
        if (cache[url]) {
          return cache[url]
        } else {
          var response = cache[url] = oauth.get(url)
          return response
        }
      }
      runForProject(repo, cachedRequest)
    }


    function addContributor (codeHtml) {
      var children = $('#contributors').children()
      if (children.length === 0) {
        // No children so just.
        $('#contributors').append(codeHtml)
      } else {
        var random_index = Math.floor(Math.random() * (children.length + 1))
        if (random_index === children.length) {
          // Add at the end.
          $('#contributors').append(codeHtml)
        } else {
          // Otherwise insert it before the chosen element.
          $(children[random_index]).before(codeHtml)
        }
      }
    }
    function contributorToHtml (project, contributor, type) {
      var username = contributor['login']
      var userDisplayName = contributor['name'] || username
      var url = 'https://github.com/' + project + '/issues?q=involves:' + username
      var avatar = contributor['avatar_url'] + '&s=128'

      // Construct the contibutor's HTML using jQuery.
      var surounding_div = $('<div class="' + type + '">')
      var linkTag = $('<a href="' + url + '"></a>')
      var avatarImg = $('<img src="' + avatar + '" width="128" alt="' + username + '">')
      var overlay = $('<div class="overlay"></div>')
      linkTag.append(avatarImg, overlay)
      var displayName = $('<div>' + userDisplayName + '</div>')

      return surounding_div.append(linkTag, displayName)
    }
    function createSpinners (elements) {
      // I needed a progress spinner thing, and this was quick and hacky
      var addedElms = $('<span>&#8226;</span><span>&#8226;</span><span>&#8226;</span>')
      $(elements).append(
        addedElms
      )
      var property = 'font-size'
      var value = '110%'
      var progressSpinnerTimeout = 0
      function timer (currIdx) {
        var progress = $('.progress')
        if (progress) {
          progressSpinnerTimeout = setTimeout(timer, 300, (currIdx + 1) % 3)
          $(addedElms).css(property, '')
          $(addedElms[currIdx]).css(property, value)
        }
      }
      timer(1)
      return function () {
        window.clearTimeout(progressSpinnerTimeout)
        addedElms.remove()
      }
    }

    function validateRepo(repo) {
      // Really dubm. Basically 1 slash with at least 1 non-slash either side.
      return /[^\/#]+\/[^\/#]+/.test(repo)
    }

    function attemptHashLoad() {
      var repoParamRegexp = /repo=([^&]+)/
      var hash = window.location.hash + ''
      if (hash.indexOf('%') !== -1) {
        // URI encoded, fix that
        hash = window.decodeURIComponent(hash)
      }
      var repoMatch = repoParamRegexp.exec(hash)
      if (!repoMatch) {
        // Nothing I can see in the URL.
        return
      }
      var repo = repoMatch[1]
      $('input[name="repo"]').val(repo)
      if (!validateRepo(repo)) {
        // Slash at the start or doesn't exist, so we know it's not a repo
        $('input[name="repo"]').addClass('invalid')
        return
      }
      var githubApi = OAuth.create('github')
      if (githubApi) {
        // We have a valid API token. Go for gold.
        bootstrapOauth(repo, githubApi);
      }
    }

    $(document).ready(function() {
      if (window.location.hash) {
        // We may be able to direct the user directly to what they are looking for. Give it a shot.
        attemptHashLoad()
      }
      $(window).on('hashchange', function(event) {
        if (event.originalEvent.newURL.endsWith('#')) {
          // We're trying to get back to the login page.
          if ($('#initial-form').is(':visible')) {
            // Already on the form page.
            // Don't need to do anything fancy
          } else {
            // Help them along by basically refreshing the page.
            window.location.hash = ''
            window.location.reload()
            event.preventDefault()
          }
        } else {
          attemptHashLoad()
        }
      })
      $('a#choose-again').click(function (event) {
        window.location.hash = ''
        window.location.reload()
        event.preventDefault()
      })
      $('button#github-oauth').click(function (event) {
        event.preventDefault()
        var repo = $('input[name="repo"]').val()
        if (!validateRepo(repo)) {
          // Invalid repo name.
          $('input[name="repo"]').addClass('invalid')
          return
        }
        $('.invalid').removeClass('invalid')
        var button = $(this).prop('disabled', true)
        var cancelSpinners = createSpinners(this)
        var x = OAuth.popup('github', {cache: true}).done(function (githubApi) {
          bootstrapOauth(repo, githubApi)
        }).fail(function (err) {
          console.log(err)
          button.addClass('invalid')
        }).always(function () {
          cancelSpinners()
          button.prop('disabled', false)
        })
      })
      $('button#github-basic').click(function (event) {
        event.preventDefault()
        var repo = $('input[name="repo"]').val()
        if (!validateRepo(repo)) {
          // Invalid repo name.
          $('input[name="repo"]').addClass('invalid')
          return
        }
        bootstrapBasic(repo)
      })
    })
  </script>
</body>
</html>
